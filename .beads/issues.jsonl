{"id":"ll-4ii","title":"Distributed Systems Enhancements for Anduril Interview Prep","description":"Add 6 production-grade distributed systems features: HLC timestamps, CRDT component merge, partition test harness, human-on-the-loop approval gate, edge bandwidth budgeting, sensor fusion. Test-driven.\n\n## Cross-Cutting Constraints\n- Test-driven: write _test.go files first, then implementation\n- All Go — no new languages\n- Existing tests must continue passing (make test)\n- Proto changes regenerated via make proto\n- Keep existing API backward-compatible\n- No new external dependencies beyond stdlib + existing (grpc, protobuf, cobra)","status":"closed","priority":2,"issue_type":"epic","owner":"boden.fuller@gmail.com","created_at":"2026-02-12T12:22:00.323085-05:00","created_by":"Boden Fuller","updated_at":"2026-02-12T12:46:39.797829-05:00","closed_at":"2026-02-12T12:46:39.797829-05:00","close_reason":"Closed","labels":["planned"]}
{"id":"ll-4ii.1","title":"HLC Package (internal/hlc/)","description":"Create internal/hlc/ package implementing Hybrid Logical Clocks. TDD approach.\n\n**Tests first:**\n- Monotonicity: successive Now() calls always increase\n- Causality: Update(remote) advances past remote\n- Concurrent safety: goroutine hammer test\n- Comparison: Compare(a, b) returns correct ordering\n\n**Implementation:**\n- Clock struct: physical time (uint64 unix nanos) + logical counter (uint32) + node ID (string)\n- Now() → new HLC (advance physical, reset logical if physical advanced, else increment logical)\n- Update(remote HLC) → advance to max(local.physical, remote.physical), set logical accordingly\n- Compare(a, b) → -1/0/1 ordering\n\n```validation\n{\"tests\": \"go test ./internal/hlc/...\", \"content_check\": {\"file\": \"internal/hlc/hlc.go\", \"pattern\": \"func.*Now\"}}\n```","status":"closed","priority":2,"issue_type":"task","owner":"boden.fuller@gmail.com","created_at":"2026-02-12T12:22:08.536163-05:00","created_by":"Boden Fuller","updated_at":"2026-02-12T12:30:46.757069-05:00","closed_at":"2026-02-12T12:30:46.757069-05:00","close_reason":"Closed","labels":["planned"],"dependencies":[{"issue_id":"ll-4ii.1","depends_on_id":"ll-4ii","type":"parent-child","created_at":"2026-02-12T12:22:08.537123-05:00","created_by":"Boden Fuller"}]}
{"id":"ll-4ii.2","title":"Proto Schema Updates (all new fields/messages)","description":"Add all new proto fields/messages needed by later phases in one batch.\n\nentity.proto additions:\n- Entity: uint64 hlc_physical = 6, uint32 hlc_logical = 7, string hlc_node = 8\n- ApprovalState enum: AUTO_APPROVED, PENDING, APPROVED, DENIED, TIMED_OUT\n- ApprovalComponent message: ApprovalState state, int64 timeout_seconds, google.protobuf.Timestamp requested_at\n- FusionComponent message: repeated string source_ids, double fused_lat, double fused_lon, float confidence\n- SourceComponent message: string sensor_id, string sensor_type\n\nstore.proto additions:\n- ApproveAction RPC (ApproveActionRequest) returns Entity\n- DenyAction RPC (DenyActionRequest) returns Entity\n- EntityEvent: add string origin_node = 3 (for relay echo suppression)\n\nRun make proto to regenerate. Verify go build ./... succeeds.\n\nPRE-MORTEM AMENDMENT: Added origin_node to EntityEvent for relay echo suppression.","status":"closed","priority":2,"issue_type":"task","owner":"boden.fuller@gmail.com","created_at":"2026-02-12T12:22:15.45467-05:00","created_by":"Boden Fuller","updated_at":"2026-02-12T12:30:46.854888-05:00","closed_at":"2026-02-12T12:30:46.854888-05:00","close_reason":"Closed","labels":["planned"],"dependencies":[{"issue_id":"ll-4ii.2","depends_on_id":"ll-4ii","type":"parent-child","created_at":"2026-02-12T12:22:15.455322-05:00","created_by":"Boden Fuller"}]}
{"id":"ll-4ii.3","title":"Store HLC Integration","description":"Integrate HLC into Store with PER-COMPONENT-KEY timestamps and functional options API.\n\nPRE-MORTEM AMENDMENTS:\n- Per-component-key HLC (NOT per-entity) — each component carries its own HLC\n- Store.New() uses functional options: New(opts ...Option) for backward compat\n- Update() merges component maps by key, only rejects if SAME component key has newer HLC\n\nTests first:\n- Create stamps HLC on each component\n- Update with newer component HLC succeeds\n- Update with stale component HLC for SAME key is rejected\n- Update with stale entity-level HLC but NEW component key succeeds (different services can write different keys concurrently)\n- Store.New() with no args still works (auto-generates node ID)\n\nImplementation:\n1. Add hlc.Clock to Store, init via WithNodeID option or auto-generate\n2. Create(): stamp each component's HLC from clock.Now()\n3. Update(): for each component key, compare HLC; keep newer; reject only same-key stale writes\n4. Propagate HLC in watch events","status":"closed","priority":2,"issue_type":"task","owner":"boden.fuller@gmail.com","created_at":"2026-02-12T12:22:22.672461-05:00","created_by":"Boden Fuller","updated_at":"2026-02-12T12:37:11.719807-05:00","closed_at":"2026-02-12T12:37:11.719807-05:00","close_reason":"Closed","labels":["planned"],"dependencies":[{"issue_id":"ll-4ii.3","depends_on_id":"ll-4ii","type":"parent-child","created_at":"2026-02-12T12:22:22.673554-05:00","created_by":"Boden Fuller"},{"issue_id":"ll-4ii.3","depends_on_id":"ll-4ii.1","type":"blocks","created_at":"2026-02-12T12:23:27.966949-05:00","created_by":"Boden Fuller"},{"issue_id":"ll-4ii.3","depends_on_id":"ll-4ii.2","type":"blocks","created_at":"2026-02-12T12:23:28.062531-05:00","created_by":"Boden Fuller"}]}
{"id":"ll-4ii.4","title":"CRDT Merge Package (internal/crdt/)","description":"Create internal/crdt/ with component merge strategies. TDD approach.\n\nPRE-MORTEM AMENDMENT: Replace ORSet with LWW-Element-Map. Components are a map of named registers, not a set. ~100 lines, not 500+.\n\nTests first (property-based):\n- Commutativity: merge(a,b) == merge(b,a)\n- Associativity: merge(merge(a,b),c) == merge(a,merge(b,c))\n- Idempotency: merge(a,a) == a\n- LWW: higher HLC wins per component key\n- MaxWins: higher threat level wins\n- Type dispatch: correct strategy selected per component key name\n\nImplementation:\n- LWWRegister: last-writer-wins keyed on HLC. For position/velocity/classification.\n- MaxWins: keep higher value. For threat level (unmarshal ThreatComponent, compare).\n- LWW-Element-Map: merge entity component maps key-by-key using above strategies\n- MergeEntity(local, remote) -\u003e merged: unmarshal Each Any, apply strategy, re-marshal\n  - position, velocity -\u003e LWW\n  - threat -\u003e MaxWins\n  - classification -\u003e LWW (confidence tiebreaker)\n  - task_catalog -\u003e LWW (simplification — latest assignment wins)\n  - unknown -\u003e LWW (default)\n\nDepends on: ll-4ii.1 (HLC package)","status":"closed","priority":2,"issue_type":"task","owner":"boden.fuller@gmail.com","created_at":"2026-02-12T12:22:27.230827-05:00","created_by":"Boden Fuller","updated_at":"2026-02-12T12:37:11.826204-05:00","closed_at":"2026-02-12T12:37:11.826204-05:00","close_reason":"Closed","labels":["planned"],"dependencies":[{"issue_id":"ll-4ii.4","depends_on_id":"ll-4ii","type":"parent-child","created_at":"2026-02-12T12:22:27.2315-05:00","created_by":"Boden Fuller"},{"issue_id":"ll-4ii.4","depends_on_id":"ll-4ii.1","type":"blocks","created_at":"2026-02-12T12:23:28.152637-05:00","created_by":"Boden Fuller"}]}
{"id":"ll-4ii.5","title":"Human-on-the-Loop Approval Gate","description":"Add human approval requirement for HIGH threat intercept actions. TDD.\n\nPRE-MORTEM AMENDMENT: Use single-goroutine event loop with select (not per-entity timer goroutines). Maintain map[entityID]context.CancelFunc for cleanup.\n\nTests first:\n- HIGH threat -\u003e pending_approval (not immediate intercept)\n- ApproveAction -\u003e transitions to intercept, assigns tasks\n- DenyAction -\u003e transitions to idle\n- Timeout -\u003e auto-deny (inject clock for deterministic tests)\n- Entity deleted while pending -\u003e cancel timer, no leak\n- LOW/MEDIUM threat -\u003e no approval needed\n\nImplementation:\n1. Approval event loop goroutine with channels for approve/deny/timeout/cancel\n2. map[entityID]*pendingApproval with cancel functions\n3. processEntity: when threat=HIGH, send to approval channel\n4. ApproveAction/DenyAction handlers in server/grpc.go\n5. Entity delete -\u003e cancel pending approval\n6. CLI: lattice-cli approve \u003cid\u003e, lattice-cli deny \u003cid\u003e\n7. Config: APPROVAL_TIMEOUT env var (default 30s)\n\nDepends on: ll-4ii.2 (proto)","status":"closed","priority":2,"issue_type":"task","owner":"boden.fuller@gmail.com","created_at":"2026-02-12T12:22:32.870849-05:00","created_by":"Boden Fuller","updated_at":"2026-02-12T12:37:11.928461-05:00","closed_at":"2026-02-12T12:37:11.928461-05:00","close_reason":"Closed","labels":["planned"],"dependencies":[{"issue_id":"ll-4ii.5","depends_on_id":"ll-4ii","type":"parent-child","created_at":"2026-02-12T12:22:32.872839-05:00","created_by":"Boden Fuller"},{"issue_id":"ll-4ii.5","depends_on_id":"ll-4ii.2","type":"blocks","created_at":"2026-02-12T12:23:28.240495-05:00","created_by":"Boden Fuller"}]}
{"id":"ll-4ii.6","title":"Mesh Relay CRDT Merge","description":"Replace last-write-wins relay with component-level CRDT merge. TDD.\n\nPRE-MORTEM AMENDMENT: Add origin-node echo suppression. Relay tags outgoing events with local node ID. Skip events where origin_node == self.\n\nTests first:\n- Two relays forwarding conflicting updates -\u003e identical merged state\n- Echo suppression: relay does NOT re-forward events it received from a peer\n- Create on peer that already has entity -\u003e merge (not overwrite)\n- Stats track merges, conflicts resolved\n\nImplementation:\n1. Add origin_node to forwarded events via gRPC metadata or EntityEvent field\n2. On watch event: if origin_node == local node -\u003e skip (echo suppression)\n3. On forward: GET current from peer, merge via crdt.MergeEntity(), PUT merged\n4. Handle new entity (no existing -\u003e just create)\n5. Track merge stats\n\nDepends on: ll-4ii.3 (Store HLC), ll-4ii.4 (CRDT)","status":"closed","priority":2,"issue_type":"task","owner":"boden.fuller@gmail.com","created_at":"2026-02-12T12:22:40.735135-05:00","created_by":"Boden Fuller","updated_at":"2026-02-12T12:41:34.434797-05:00","closed_at":"2026-02-12T12:41:34.434797-05:00","close_reason":"Closed","labels":["planned"],"dependencies":[{"issue_id":"ll-4ii.6","depends_on_id":"ll-4ii","type":"parent-child","created_at":"2026-02-12T12:22:40.735908-05:00","created_by":"Boden Fuller"},{"issue_id":"ll-4ii.6","depends_on_id":"ll-4ii.3","type":"blocks","created_at":"2026-02-12T12:23:28.327311-05:00","created_by":"Boden Fuller"},{"issue_id":"ll-4ii.6","depends_on_id":"ll-4ii.4","type":"blocks","created_at":"2026-02-12T12:23:28.415101-05:00","created_by":"Boden Fuller"}]}
{"id":"ll-4ii.7","title":"Sensor Fusion Service","description":"Add multi-sensor track correlation and fusion. TDD.\n\nPRE-MORTEM AMENDMENT: Add fused entity cleanup — watch source deletes, cascade-delete fused entities.\n\nTests first:\n- Two tracks within distance -\u003e correlated, fused entity created\n- Tracks beyond threshold -\u003e not correlated\n- Fused position = weighted average\n- Source track deleted -\u003e fused entity deleted (cascade)\n- De-correlation when tracks diverge\n\nImplementation:\n1. cmd/radar-sim/: noisier position-only, SourceComponent{sensor_type=\"radar\"}\n2. Modify sensor-sim: add SourceComponent{sensor_type=\"eo\"}\n3. internal/fusion/fusion.go: watch all tracks, distance matrix\n4. Correlate: distance \u003c threshold (configurable, default ~0.01 degrees) + same EntityType\n5. Fused entity with FusionComponent{source_ids, fused_lat, fused_lon, confidence}\n6. Cascade delete: watch DELETE events, remove fused entities for deleted sources\n7. Makefile: add radar-sim build target\n\nDepends on: ll-4ii.2 (proto), ll-4ii.3 (Store HLC)","status":"closed","priority":2,"issue_type":"task","owner":"boden.fuller@gmail.com","created_at":"2026-02-12T12:22:46.814327-05:00","created_by":"Boden Fuller","updated_at":"2026-02-12T12:41:34.533085-05:00","closed_at":"2026-02-12T12:41:34.533085-05:00","close_reason":"Closed","labels":["planned"],"dependencies":[{"issue_id":"ll-4ii.7","depends_on_id":"ll-4ii","type":"parent-child","created_at":"2026-02-12T12:22:46.815105-05:00","created_by":"Boden Fuller"},{"issue_id":"ll-4ii.7","depends_on_id":"ll-4ii.2","type":"blocks","created_at":"2026-02-12T12:23:28.503359-05:00","created_by":"Boden Fuller"},{"issue_id":"ll-4ii.7","depends_on_id":"ll-4ii.3","type":"blocks","created_at":"2026-02-12T12:23:28.595403-05:00","created_by":"Boden Fuller"}]}
{"id":"ll-4ii.8","title":"Edge Bandwidth Budgeting","description":"Add priority-based bandwidth management to mesh relay. TDD approach.\n\n**Tests first:**\n- HIGH threat always forwarded even at 0 remaining budget\n- LOW threat dropped when over budget\n- Coalescing: 3 pending position updates for same entity → only latest sent\n- Priority ordering: delete \u003e HIGH \u003e MEDIUM \u003e LOW \u003e NONE \u003e position-only\n- Token bucket: refills at configured rate\n\n**Implementation:**\n1. internal/mesh/budget.go: TokenBucket struct (bytes/sec rate, burst size)\n2. PriorityQueue: orders events by threat level + event type\n3. Coalescer: deduplicates same-entity position updates, keeps latest\n4. Integrate into relay pipeline: receive → prioritize → coalesce → budget gate → forward\n5. Config: MESH_BANDWIDTH_BPS, MESH_BURST_BYTES env vars\n6. Metrics in Stats: queue_depth, drop_count, bytes_sent_by_priority\n\n**Depends on:** ll-4ii.6 (Mesh CRDT merge)\n\n```validation\n{\"tests\": \"go test ./internal/mesh/...\", \"content_check\": {\"file\": \"internal/mesh/budget.go\", \"pattern\": \"TokenBucket\"}}\n```","status":"closed","priority":2,"issue_type":"task","owner":"boden.fuller@gmail.com","created_at":"2026-02-12T12:22:55.050259-05:00","created_by":"Boden Fuller","updated_at":"2026-02-12T12:46:36.01344-05:00","closed_at":"2026-02-12T12:46:36.01344-05:00","close_reason":"Closed","labels":["planned"],"dependencies":[{"issue_id":"ll-4ii.8","depends_on_id":"ll-4ii","type":"parent-child","created_at":"2026-02-12T12:22:55.051018-05:00","created_by":"Boden Fuller"},{"issue_id":"ll-4ii.8","depends_on_id":"ll-4ii.6","type":"blocks","created_at":"2026-02-12T12:23:28.690919-05:00","created_by":"Boden Fuller"}]}
{"id":"ll-4ii.9","title":"Partition Test Harness (Jepsen-style)","description":"Jepsen-style partition tests. THIS IS the test — TDD is the whole point.\n\nPRE-MORTEM AMENDMENT: Use listener-level partition (refuse new connections, close existing) instead of TCP proxy. ~50 lines vs 200+.\n\nTests:\n1. ControllableListener wrapping net.Listener: Partition() closes all conns and refuses new. Heal() resumes accepting.\n2. 3-store triangle topology with mesh relays\n3. Create entity on A -\u003e verify replicated to B, C\n4. Partition B from {A, C}\n5. Conflicting updates: A sets speed=100kts, B sets speed=400kts\n6. Heal partition\n7. Assert: all 3 converge (CRDT merge determines winner)\n8. Assert: no entity lost, all components present\n9. Assert: convergence within bounded time\n\nDepends on: ll-4ii.6 (Mesh CRDT)","status":"closed","priority":2,"issue_type":"task","owner":"boden.fuller@gmail.com","created_at":"2026-02-12T12:22:59.363681-05:00","created_by":"Boden Fuller","updated_at":"2026-02-12T12:46:36.016021-05:00","closed_at":"2026-02-12T12:46:36.016021-05:00","close_reason":"Closed","labels":["planned"],"dependencies":[{"issue_id":"ll-4ii.9","depends_on_id":"ll-4ii","type":"parent-child","created_at":"2026-02-12T12:22:59.364335-05:00","created_by":"Boden Fuller"},{"issue_id":"ll-4ii.9","depends_on_id":"ll-4ii.6","type":"blocks","created_at":"2026-02-12T12:23:28.782655-05:00","created_by":"Boden Fuller"}]}
