version: 1
mission: "Mini Lattice in Go â€” learn distributed systems (gRPC, Protobuf, Entity-Component, microservices)"

goals:
  # --- Tier 1: Must never break ---

  - id: build-clean
    description: "All packages build without errors"
    check: "go build ./..."
    weight: 10

  - id: tests-pass
    description: "All tests pass with race detector"
    check: "go test -race -count=1 ./..."
    weight: 10

  - id: vet-clean
    description: "go vet reports no issues"
    check: "go vet ./..."
    weight: 9

  # --- Tier 2: Code quality ---

  - id: lint-clean
    description: "golangci-lint passes (install latest if version mismatch)"
    check: "golangci-lint run ./..."
    weight: 8

  - id: coverage-80
    description: "All internal packages have >= 80% test coverage"
    check: "go test -cover ./internal/... 2>&1 | grep 'coverage:' | sed 's/.*coverage: //' | sed 's/% .*//' | awk '{ if ($1+0 < 80.0) exit 1 }'"
    weight: 7

  # --- Tier 3: Robustness ---

  - id: graceful-shutdown
    description: "All integration tests pass with short timeouts (proves context cancellation works)"
    check: "go test -run Integration -timeout 30s ./internal/..."
    weight: 6

  - id: mesh-bidirectional
    description: "Mesh relay supports bidirectional replication (both nodes relay to each other)"
    check: "go test -v -run TestRelayBidirectional ./internal/mesh/ 2>&1 | grep -q 'PASS: TestRelayBidirectional'"
    weight: 5

  - id: cli-help
    description: "lattice-cli --help exits 0 and shows subcommands"
    check: "go run ./cmd/lattice-cli -- --help 2>&1 | grep -q 'list'"
    weight: 4

  # --- Tier 4: Production readiness ---

  - id: structured-logging
    description: "Services use slog structured logging instead of log.Printf"
    check: "grep -rn 'log\\.Printf\\|log\\.Fatalf\\|log\\.Println' internal/ cmd/ --include='*.go' | grep -v _test.go | grep -c . | grep -q '^0$'"
    weight: 4

  - id: ci-pipeline
    description: "GitHub Actions CI runs build + test + lint on push"
    check: "test -f .github/workflows/ci.yml && grep -q 'go test' .github/workflows/ci.yml"
    weight: 3

  - id: configurable-bbox
    description: "Sensor-sim bounding box is configurable via env vars (BBOX_MIN_LAT, etc)"
    check: "grep -q 'BBOX_MIN_LAT\\|BBOX' cmd/sensor-sim/main.go"
    weight: 2

  - id: entity-ttl
    description: "Entity store supports TTL-based expiration (stale tracks auto-delete)"
    check: "go test -v -run TestTTL ./internal/store/ 2>&1 | grep -q 'PASS: TestTTL'"
    weight: 2
